services:
  redis:
    image: redis:7-alpine
    ports: ["6379:6379"]
    volumes:
      - redis_data:/data
    restart: unless-stopped

  rabbitmq:
    image: rabbitmq:3-management
    ports: ["5672:5672", "15672:15672"]
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
    restart: unless-stopped

  postgres:
    image: postgres:15
    environment:
      POSTGRES_PASSWORD: password
      POSTGRES_DB: eboocommerce
    ports: ["5432:5432"]
    volumes:
      - postgres_data:/var/lib/postgresql/data
    restart: unless-stopped

  api-gateway:
    build:
      context: .
      dockerfile: ./api-gateway/Dockerfile
    environment:
      PORT: 4000
      AUTH_SERVICE_URL: http://auth-service:4001
      PRODUCT_SERVICE_URL: http://product-service:4002
      PRICING_SERVICE_URL: http://pricing-service:4003
      INVENTORY_SERVICE_URL: http://inventory-service:4004
      CART_SERVICE_URL: http://cart-service:4005
      ORDER_SERVICE_URL: http://order-service:4006
      PAYMENT_SERVICE_URL: http://payment-service:4007
      SELLER_SERVICE_URL: http://seller-service:4008
      SHIPPING_SERVICE_URL: http://shipping-service:4009
      NOTIFICATION_SERVICE_URL: http://notification-service:4010
      REVIEW_SERVICE_URL: http://review-service:4011
      REDIS_URL: redis://redis:6379
      JWT_SECRET: dev-secret
    ports: ["4000:4000"]
    depends_on: [redis]
    restart: unless-stopped

  auth-service:
    build:
      context: .
      dockerfile: ./services/auth-service/Dockerfile
    environment:
      PORT: 4001
      DATABASE_URL: postgresql://postgres:password@postgres:5432/eboocommerce
      REDIS_URL: redis://redis:6379
      JWT_SECRET: dev-secret
      JWT_REFRESH_SECRET: dev-refresh
      SERVICE_NAME: auth-service
    ports: ["4001:4001"]
    depends_on: [postgres, redis]
    restart: unless-stopped

  product-service:
    build:
      context: .
      dockerfile: ./services/product-service/Dockerfile
    environment:
      PORT: 4002
      DATABASE_URL: postgresql://postgres:password@postgres:5432/eboocommerce
      REDIS_URL: redis://redis:6379
      SERVICE_NAME: product-service
    ports: ["4002:4002"]
    depends_on: [postgres, redis]
    restart: unless-stopped

  pricing-service:
    build:
      context: .
      dockerfile: ./services/pricing-service/Dockerfile
    environment:
      PORT: 4003
      DATABASE_URL: postgresql://postgres:password@postgres:5432/eboocommerce
      SERVICE_NAME: pricing-service
    ports: ["4003:4003"]
    depends_on: [postgres]
    restart: unless-stopped

  inventory-service:
    build:
      context: .
      dockerfile: ./services/inventory-service/Dockerfile
    environment:
      PORT: 4004
      DATABASE_URL: postgresql://postgres:password@postgres:5432/eboocommerce
      SERVICE_NAME: inventory-service
    ports: ["4004:4004"]
    depends_on: [postgres]
    restart: unless-stopped

  cart-service:
    build:
      context: .
      dockerfile: ./services/cart-service/Dockerfile
    environment:
      PORT: 4005
      DATABASE_URL: postgresql://postgres:password@postgres:5432/eboocommerce
      REDIS_URL: redis://redis:6379
      SERVICE_NAME: cart-service
    ports: ["4005:4005"]
    depends_on: [postgres, redis]
    restart: unless-stopped

  order-service:
    build:
      context: .
      dockerfile: ./services/order-service/Dockerfile
    environment:
      PORT: 4006
      DATABASE_URL: postgresql://postgres:password@postgres:5432/eboocommerce
      RABBITMQ_URL: amqp://rabbitmq:5672
      SERVICE_NAME: order-service
    ports: ["4006:4006"]
    depends_on: [postgres, rabbitmq]
    restart: unless-stopped

  payment-service:
    build:
      context: .
      dockerfile: ./services/payment-service/Dockerfile
    environment:
      PORT: 4007
      DATABASE_URL: postgresql://postgres:password@postgres:5432/eboocommerce
      RABBITMQ_URL: amqp://rabbitmq:5672
      SERVICE_NAME: payment-service
    ports: ["4007:4007"]
    depends_on: [postgres, rabbitmq]
    restart: unless-stopped

  seller-service:
    build:
      context: .
      dockerfile: ./services/seller-service/Dockerfile
    environment:
      PORT: 4008
      DATABASE_URL: postgresql://postgres:password@postgres:5432/eboocommerce
      SERVICE_NAME: seller-service
    ports: ["4008:4008"]
    depends_on: [postgres]
    restart: unless-stopped

  shipping-service:
    build:
      context: .
      dockerfile: ./services/shipping-service/Dockerfile
    environment:
      PORT: 4009
      DATABASE_URL: postgresql://postgres:password@postgres:5432/eboocommerce
      SERVICE_NAME: shipping-service
    ports: ["4009:4009"]
    depends_on: [postgres]
    restart: unless-stopped

  notification-service:
    build:
      context: .
      dockerfile: ./services/notification-service/Dockerfile
    environment:
      PORT: 4010
      DATABASE_URL: postgresql://postgres:password@postgres:5432/eboocommerce
      RABBITMQ_URL: amqp://rabbitmq:5672
      SERVICE_NAME: notification-service
    ports: ["4010:4010"]
    depends_on: [postgres, rabbitmq]
    restart: unless-stopped

  review-service:
    build:
      context: .
      dockerfile: ./services/review-service/Dockerfile
    environment:
      PORT: 4011
      DATABASE_URL: postgresql://postgres:password@postgres:5432/eboocommerce
      SERVICE_NAME: review-service
    ports: ["4011:4011"]
    depends_on: [postgres]
    restart: unless-stopped

  docs-service:
    build:
      context: .
      dockerfile: ./services/docs-service/Dockerfile
    environment:
      PORT: 4012
      SERVICE_NAME: docs-service
      AUTH_SERVICE_URL: http://auth-service:4001
      PRODUCT_SERVICE_URL: http://product-service:4002
      PRICING_SERVICE_URL: http://pricing-service:4003
      INVENTORY_SERVICE_URL: http://inventory-service:4004
      CART_SERVICE_URL: http://cart-service:4005
      ORDER_SERVICE_URL: http://order-service:4006
      PAYMENT_SERVICE_URL: http://payment-service:4007
      SELLER_SERVICE_URL: http://seller-service:4008
      SHIPPING_SERVICE_URL: http://shipping-service:4009
      NOTIFICATION_SERVICE_URL: http://notification-service:4010
      REVIEW_SERVICE_URL: http://review-service:4011
    ports: ["4012:4012"]
    depends_on: [auth-service, product-service, pricing-service, inventory-service, cart-service, order-service, payment-service, seller-service, shipping-service, notification-service, review-service]
    restart: unless-stopped

volumes:
  # Single PostgreSQL database for all services
  postgres_data:
  
  # Infrastructure volumes
  redis_data:
  rabbitmq_data: