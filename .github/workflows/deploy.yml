name: Deploy to CentOS

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      services: ${{ steps.changes.outputs.services }}
      shared: ${{ steps.changes.outputs.shared }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2
      
      - name: Detect changed services
        id: changes
        run: |
          SERVICES=""
          SHARED_CHANGED="false"
          
          # Get the previous commit
          PREV_COMMIT=$(git rev-parse HEAD~1 2>/dev/null || echo "")
          CURRENT_COMMIT=$(git rev-parse HEAD)
          
          echo "Comparing commits: $PREV_COMMIT -> $CURRENT_COMMIT"
          echo "Changed files:"
          git diff --name-only $PREV_COMMIT $CURRENT_COMMIT || echo "No previous commit found"
          
          # If no previous commit, build all services (first deployment)
          if [ -z "$PREV_COMMIT" ]; then
            SERVICES="api-gateway auth-service product-service pricing-service inventory-service cart-service order-service payment-service seller-service shipping-service notification-service review-service docs-service"
            echo "services=$SERVICES" >> $GITHUB_OUTPUT
            echo "shared=false" >> $GITHUB_OUTPUT
            echo "First deployment - building all services"
            exit 0
          fi
          
          # Get list of changed files
          CHANGED_FILES=$(git diff --name-only $PREV_COMMIT $CURRENT_COMMIT)
          
          # Check if shared code changed
          if echo "$CHANGED_FILES" | grep -q "^shared/"; then
            SHARED_CHANGED="true"
            SERVICES="api-gateway auth-service product-service pricing-service inventory-service cart-service order-service payment-service seller-service shipping-service notification-service review-service docs-service"
            echo "✓ Shared code changed - building all services"
          else
            # Check api-gateway
            if echo "$CHANGED_FILES" | grep -q "^api-gateway/"; then
              SERVICES="$SERVICES api-gateway"
              echo "✓ api-gateway changed"
            fi
            
            # Check each service in services/ directory
            for service in auth-service product-service pricing-service inventory-service cart-service order-service payment-service seller-service shipping-service notification-service review-service docs-service; do
              if echo "$CHANGED_FILES" | grep -q "^services/$service/"; then
                SERVICES="$SERVICES $service"
                echo "✓ $service changed"
              fi
            done
            
            # Check if docker-compose.yml or Dockerfile changed (affects all services)
            if echo "$CHANGED_FILES" | grep -qE "^(docker-compose\.yml|\.github/workflows/)"; then
              if [ -z "$SERVICES" ]; then
                SERVICES="api-gateway auth-service product-service pricing-service inventory-service cart-service order-service payment-service seller-service shipping-service notification-service review-service docs-service"
                echo "✓ Infrastructure files changed - building all services"
              fi
            fi
            
            # If no services detected, build all (safety measure)
            if [ -z "$SERVICES" ]; then
              SERVICES="api-gateway auth-service product-service pricing-service inventory-service cart-service order-service payment-service seller-service shipping-service notification-service review-service docs-service"
              echo "⚠ No specific changes detected - building all services (safety measure)"
            fi
          fi
          
          # Trim leading space
          SERVICES=$(echo $SERVICES | sed 's/^ //')
          
          echo ""
          echo "=========================================="
          echo "Services to rebuild: $SERVICES"
          echo "=========================================="
          
          echo "services=$SERVICES" >> $GITHUB_OUTPUT
          echo "shared=$SHARED_CHANGED" >> $GITHUB_OUTPUT

  deploy:
    needs: detect-changes
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
      
      - name: Deploy to CentOS
        env:
          SERVICES: ${{ needs.detect-changes.outputs.services }}
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << EOF
            set -e
            cd ${{ secrets.DEPLOY_PATH }}
            
            echo "Pulling latest code..."
            git pull origin main || git pull origin master
            
            echo "Starting infrastructure services (databases with volumes - data persists)..."
            
            # Start PostgreSQL database (single database for all services)
            docker-compose up -d postgres
            
            # Start Redis and RabbitMQ
            docker-compose up -d redis rabbitmq
            
            # Wait for databases to be ready
            echo "Waiting for databases to be ready..."
            sleep 15
            
            # Build and start only changed services
            for service in $SERVICES; do
              echo "Building and starting $service..."
              docker-compose build $service
              docker-compose up -d $service
            done
            
            # Run migrations for all Prisma services (all use PostgreSQL)
            echo "Running database migrations..."
            docker-compose exec -T auth-service npx prisma migrate deploy || true
            docker-compose exec -T product-service npx prisma migrate deploy || true
            docker-compose exec -T pricing-service npx prisma migrate deploy || true
            docker-compose exec -T inventory-service npx prisma migrate deploy || true
            docker-compose exec -T cart-service npx prisma migrate deploy || true
            docker-compose exec -T order-service npx prisma migrate deploy || true
            docker-compose exec -T payment-service npx prisma migrate deploy || true
            docker-compose exec -T seller-service npx prisma migrate deploy || true
            docker-compose exec -T shipping-service npx prisma migrate deploy || true
            docker-compose exec -T notification-service npx prisma migrate deploy || true
            docker-compose exec -T review-service npx prisma migrate deploy || true
            
            # Clean up old images
            echo "Cleaning up old Docker images..."
            docker image prune -f
            
            echo "Deployment complete!"
            echo "Service status:"
            docker-compose ps
          EOF
